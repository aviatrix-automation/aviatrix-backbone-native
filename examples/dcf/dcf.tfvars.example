# ============================================================================
# Distributed Cloud Firewall (DCF) Module - Example Configuration
# ============================================================================
# This file demonstrates all available variables for the DCF module.
# Copy this file and customize for your environment.
#
# Usage:
#   terraform -chdir=modules/control/dcf init
#   terraform -chdir=modules/control/dcf plan -var-file=../../../examples/dcf/dcf.tfvars
#   terraform -chdir=modules/control/dcf apply -var-file=../../../examples/dcf/dcf.tfvars
# ============================================================================

# ----------------------------------------------------------------------------
# Required Variables
# ----------------------------------------------------------------------------

# AWS region for SSM parameter retrieval (controller credentials)
aws_ssw_region = "us-east-1"

# ----------------------------------------------------------------------------
# DCF Global Settings
# ----------------------------------------------------------------------------

enable_distributed_firewalling = true

# Default action for traffic not matching any policy: "PERMIT" or "DENY"
distributed_firewalling_default_action_rule_action = "DENY"

distributed_firewalling_default_action_rule_logging = true

# ----------------------------------------------------------------------------
# Smart Groups
# ----------------------------------------------------------------------------
# Each entry supports exactly one selector type:
#
#   cidr       - match by IP CIDR block
#   tags       - match VMs by tag key/value pairs
#   s2c        - match one explicit Site2Cloud connection by name
#   s2c_domain - auto-resolve all external-{domain}-* S2C connections
#                (same naming convention as the segmentation module)
#
# s2c_domain fetches the connection list from the controller at apply time
# and creates one selector per matching connection (OR logic). This means
# a single "prod-remotes" smart group will match traffic from all prod S2C
# connections without needing to list them explicitly.

smarties = {
  # ------------------------------------------------------------------
  # CIDR-based smart groups
  # ------------------------------------------------------------------
  "web-tier" = {
    cidr = "10.1.0.0/24"
  }

  "app-tier" = {
    cidr = "10.2.0.0/24"
  }

  "db-tier" = {
    cidr = "10.3.0.0/24"
  }

  "mgmt-network" = {
    cidr = "10.254.0.0/24"
  }

  # ------------------------------------------------------------------
  # Tag-based smart groups (VM/instance tags)
  # ------------------------------------------------------------------
  "prod-servers" = {
    tags = {
      "Environment" = "Production"
      "Tier"        = "Application"
    }
  }

  "dev-servers" = {
    tags = {
      "Environment" = "Development"
    }
  }

  # ------------------------------------------------------------------
  # S2C smart groups — explicit connection name
  # Use when you need to target a single known connection.
  # ------------------------------------------------------------------
  "chicago-branch" = {
    s2c = "external-prod-chicago"
  }

  # ------------------------------------------------------------------
  # S2C smart groups — domain-based auto-resolution
  #
  # The module queries list_site2cloud and matches all connections whose
  # name starts with "external-" and contains the domain name after
  # that prefix (case-insensitive substring match).
  #
  # Example: s2c_domain = "prod" matches:
  #   - external-prod-chicago
  #   - external-prod-newyork
  #   - external-prod-london
  # Each becomes a separate selector (OR logic) in the smart group.
  # ------------------------------------------------------------------
  "prod-remote-sites" = {
    s2c_domain = "prod"
  }

  "dev-remote-sites" = {
    s2c_domain = "dev"
  }

  "shared-services-remotes" = {
    s2c_domain = "shared"
  }
}

# ----------------------------------------------------------------------------
# Firewall Policies
# ----------------------------------------------------------------------------
# Policies are evaluated in priority order (lower number = higher priority).
# Smart group names reference keys from the smarties map above, or the name
# of any pre-existing smart group on the controller.

policies = {
  # =========================================================================
  # Critical Deny Rules  (priority 1-99)
  # =========================================================================

  "deny-dev-to-prod" = {
    action           = "DENY"
    priority         = 10
    protocol         = "any"
    logging          = true
    watch            = true
    src_smart_groups = ["dev-servers", "dev-remote-sites"]
    dst_smart_groups = ["prod-servers", "prod-remote-sites"]
    port_ranges      = []
  }

  "deny-remotes-to-db" = {
    action           = "DENY"
    priority         = 20
    protocol         = "any"
    logging          = true
    watch            = true
    src_smart_groups = ["prod-remote-sites", "dev-remote-sites"]
    dst_smart_groups = ["db-tier"]
    port_ranges      = []
  }

  # =========================================================================
  # Core Allow Rules  (priority 100-199)
  # =========================================================================

  "allow-web-to-app" = {
    action           = "PERMIT"
    priority         = 100
    protocol         = "tcp"
    logging          = false
    watch            = false
    src_smart_groups = ["web-tier"]
    dst_smart_groups = ["app-tier"]
    port_ranges      = ["443", "8080"]
  }

  "allow-app-to-db" = {
    action           = "PERMIT"
    priority         = 110
    protocol         = "tcp"
    logging          = true
    watch            = false
    src_smart_groups = ["app-tier"]
    dst_smart_groups = ["db-tier"]
    port_ranges      = ["3306", "5432"]
  }

  # S2C smart groups used like any other smart group in policies
  "allow-prod-remotes-to-app" = {
    action           = "PERMIT"
    priority         = 120
    protocol         = "tcp"
    logging          = true
    watch            = false
    src_smart_groups = ["prod-remote-sites"]
    dst_smart_groups = ["app-tier"]
    port_ranges      = ["443", "8443"]
  }

  "allow-chicago-branch-to-web" = {
    action           = "PERMIT"
    priority         = 130
    protocol         = "tcp"
    logging          = true
    watch            = false
    src_smart_groups = ["chicago-branch"]
    dst_smart_groups = ["web-tier"]
    port_ranges      = ["443"]
  }

  # =========================================================================
  # Management Rules  (priority 200-299)
  # =========================================================================

  "allow-mgmt-ssh-rdp" = {
    action           = "PERMIT"
    priority         = 200
    protocol         = "tcp"
    logging          = true
    watch            = false
    src_smart_groups = ["mgmt-network"]
    dst_smart_groups = ["web-tier", "app-tier", "db-tier"]
    port_ranges      = ["22", "3389"]
  }

  # ICMP has no port ranges
  "allow-mgmt-icmp" = {
    action           = "PERMIT"
    priority         = 210
    protocol         = "icmp"
    logging          = false
    watch            = false
    src_smart_groups = ["mgmt-network"]
    dst_smart_groups = ["web-tier", "app-tier", "db-tier", "prod-remote-sites"]
    port_ranges      = []
  }

  # =========================================================================
  # Watch / Monitor Rules  (priority 500+)
  # =========================================================================

  "watch-remote-to-db" = {
    action           = "PERMIT"
    priority         = 500
    protocol         = "tcp"
    logging          = true
    watch            = true
    src_smart_groups = ["prod-remote-sites"]
    dst_smart_groups = ["db-tier"]
    port_ranges      = ["3306", "5432"]
  }
}

# ----------------------------------------------------------------------------
# Notes
# ----------------------------------------------------------------------------

# Priority guidelines:
#   1-99   critical deny rules
#   100-199 core application allow rules
#   200-299 management and operational rules
#   500+   watch/monitor rules (observe without enforcing)

# Protocol options: "tcp", "udp", "icmp", "any"
# ICMP must have an empty port_ranges list.

# s2c_domain naming convention (same as segmentation module):
#   Connection name must start with "external-" and contain the domain
#   name anywhere after that prefix. Matching is case-insensitive.
#   Example connections matched by s2c_domain = "prod":
#     external-prod-chicago, external-prod-london, external-prod-dr
